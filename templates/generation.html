{% raw %}{% extends "base.html" %}

{% block title %}G√©n√©ration de Voyage{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <style>
        /* Styles de votre app.py original */
        .container {max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden;}
        .form-container {padding: 40px;}
        .form-group {margin-bottom: 25px; width: 100%;}
        label {display: block; margin-bottom: 8px; font-weight: 600; color: #333;}
        input, select, textarea {width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; box-sizing: border-box;}
        input[type="checkbox"] { width: auto; }
        input:focus, select:focus, textarea:focus {outline: none; border-color: #3B82F6;}
        textarea {font-family: 'Segoe UI', sans-serif; resize: vertical; min-height: 80px;}
        #date_range, #cancellation_date {cursor: pointer; background-color: white;}
        .input-with-button {display: flex; align-items: center; gap: 10px;}
        .search-btn {padding: 8px 12px; font-size: 14px; font-weight: 600; background-color: #e0e0e0; border: 1px solid #ccc; border-radius: 8px; cursor: pointer;}
        .form-row {display: flex; gap: 20px;}
        .generate-btn {background: linear-gradient(45deg, #3B82F6, #60A5FA); color: white; border: none; padding: 15px 40px; border-radius: 25px; font-size: 18px; font-weight: 600; cursor: pointer; width: 100%;}
        .loading {display: none; text-align: center; padding: 30px;}
        .loading-spinner {border: 4px solid #f3f3f3; border-top: 4px solid #3B82F6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;}
        @keyframes spin {0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);}}
        .result {display: none; padding: 30px; background: #f8f9fa; border-top: 1px solid #e1e5e9;}
        .success {color: #28a745; font-size: 18px; font-weight: 600; text-align: center;}
        .error {color: #dc3545; font-size: 18px; font-weight: 600;}
        .button-container {margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; align-items: center;}
        .download-btn, .view-btn, .edit-btn, .html-code-btn, .reset-btn {color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; text-decoration: none; cursor: pointer;}
        .download-btn {background: #28a745;}
        .view-btn {background: #3B82F6;}
        .edit-btn {background: #ffc107; color: #333;}
        .html-code-btn {background: #6c757d;}
        .reset-btn { background: #9ca3af; padding: 8px 12px; font-size: 20px; line-height: 1; }
        .video-edit-form { margin-top: 20px; display: flex; gap: 10px; align-items: center; padding: 15px; background-color: #e9ecef; border-radius: 10px;}
        .stats {display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;}
        .stat-item {background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
        .stat-number {font-size: 24px; font-weight: bold; color: #3B82F6;}
        .stat-label {color: #666; font-size: 14px;}
        .pac-container {z-index: 10000 !important;}
        h3.section-divider {text-align: center; border-bottom: 2px solid #e1e5e9; line-height: 0.1em; margin: 35px 0 25px;}
        h3.section-divider span { background:#fff; padding:0 10px; color: #aaa; font-size: 0.9em; text-transform: uppercase;}
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .html-textarea { width: 100%; height: 400px; border: 1px solid #ccc; padding: 10px; font-family: monospace; white-space: pre; overflow: auto; resize: vertical; border-radius: 5px; }
        .cost-calculator { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; background-color: #f8fafc; padding: 10px; border-radius: 10px; margin-top: -10px; margin-bottom: 25px; }
        .cost-calculator div { text-align: center; }
        .cost-calculator p { margin: 0; color: #4b5563; font-weight: 500; font-size: 12px; }
        .cost-calculator .cost-value { font-size: 18px; font-weight: bold; color: #1e293b; }
        @media (max-width: 768px) {.form-row {flex-direction: column; gap: 0;} .form-container {padding: 20px;}}
    </style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="form-container">
        <form id="voyageForm">
            <h3 class="section-divider"><span>D√©tails du S√©jour</span></h3>
            <div class="form-row">
                <div class="form-group"><label for="hotel_name">üè® Nom de l'h√¥tel</label><input type="text" id="hotel_name" name="hotel_name" required placeholder="Saisir un nom d'h√¥tel..."></div>
                <div class="form-group"><label for="destination">üìç Destination</label><input type="text" id="destination" name="destination" required placeholder="Saisir une destination..."></div>
            </div>
            <div class="form-row">
                <div class="form-group" style="width: 100%;"><label for="date_range">üóìÔ∏è P√©riode du s√©jour</label><input type="text" id="date_range" readonly placeholder="Cliquez pour choisir les dates"><input type="hidden" id="date_start" name="date_start"><input type="hidden" id="date_end" name="date_end"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label for="stars">‚≠ê Cat√©gorie de l'h√¥tel</label><select id="stars" name="stars"><option value="3">3‚≠ê</option><option value="4" selected>4‚≠ê</option><option value="5">5‚≠ê</option></select></div>
                <div class="form-group"><label for="num_people">üë• Nombre de personnes</label><input type="number" id="num_people" name="num_people" value="2" min="1"></div>
            </div>

            <h3 class="section-divider"><span>D√©tails du Vol & Transferts</span></h3>
            <div class="form-row">
                <div class="form-group"><label for="departure_city">‚úàÔ∏è A√©roport de d√©part</label><input type="text" id="departure_city" name="departure_city" placeholder="Saisir un a√©roport..."></div>
                <div class="form-group"><label for="arrival_airport">üõ¨ A√©roport d'arriv√©e</label><input type="text" id="arrival_airport" name="arrival_airport" placeholder="Saisir un a√©roport..."></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label for="flight_price">üí∞ Prix du vol (‚Ç¨)</label><div class="input-with-button"><input type="number" id="flight_price" name="flight_price" value="0" class="cost-input"><button type="button" id="searchFlightsBtn" class="search-btn" title="Rechercher sur Google Flights">üîé</button></div></div>
                <div class="form-group"><label for="transfer_cost">üöê Co√ªt des Transferts (‚Ç¨)</label><input type="number" id="transfer_cost" name="transfer_cost" value="0" class="cost-input"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label for="car_rental_cost">üöó Voiture de location (‚Ç¨)</label><input type="number" id="car_rental_cost" name="car_rental_cost" value="0" class="cost-input"></div>
            </div>

            <h3 class="section-divider"><span>D√©tails du Prix</span></h3>
            <div class="form-row">
                <div class="form-group"><label for="hotel_b2b_price">üí∞ Tarif H√¥tel B2B (‚Ç¨)</label><input type="number" id="hotel_b2b_price" name="hotel_b2b_price" required placeholder="ex: 2000" class="cost-input"></div>
                <div class="form-group"><label for="hotel_b2c_price">üí≥ Tarif H√¥tel B2C (‚Ç¨)</label><div class="input-with-button"><input type="number" id="hotel_b2c_price" name="hotel_b2c_price" required placeholder="ex: 2800" class="cost-input"><button type="button" id="searchBookingBtn" class="search-btn" title="Rechercher sur Booking.com">üîé</button></div></div>
            </div>
             <div class="form-group"><label for="pack_price">üì¶ Prix du pack (‚Ç¨)</label><input type="number" id="pack_price" name="pack_price" required placeholder="ex: 2400" class="cost-input"></div>
             
             <div class="cost-calculator">
                <div><p>Co√ªt B2B</p><span id="total-b2b-cost" class="cost-value">0 ‚Ç¨</span></div>
                <div><p>Co√ªt B2C</p><span id="total-b2c-cost" class="cost-value">0 ‚Ç¨</span></div>
                <div><p>√âcart B2C/B2B</p><span id="b2c-b2b-gap" class="cost-value">0 ‚Ç¨</span></div>
                <div><p>√âconomie Client</p><span id="client-saving" class="cost-value" style="color: #10b981;">0 ‚Ç¨</span></div>
                <div><p>Marge Finale</p><span id="final-margin" class="cost-value" style="color: #2563eb;">0 ‚Ç¨</span></div>
            </div>

            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="display: flex; align-items: center; flex-shrink: 0;">
                        <input type="checkbox" id="has_cancellation" name="has_cancellation">
                        <label for="has_cancellation" style="margin-bottom: 0;">Annulation gratuite</label>
                    </div>
                    <div id="cancellation_date_wrapper" style="display: none; flex-grow: 1;">
                        <input type="text" id="cancellation_date" name="cancellation_date" readonly placeholder="Jusqu'au...">
                    </div>
                </div>
                <div id="cancellation-warning" class="text-sm text-orange-600 mt-2" style="display: none;"></div>
            </div>
            
            <div class="form-group"><div style="display: flex; align-items: center; gap: 15px;"><div style="display: flex; align-items: center; flex-shrink: 0;"><input type="checkbox" id="has_cancellation" name="has_cancellation"><label for="has_cancellation" style="margin-bottom: 0;">Annulation gratuite</label></div><div id="cancellation_date_wrapper" style="display: none; flex-grow: 1;"><input type="text" id="cancellation_date" name="cancellation_date" readonly placeholder="Jusqu'au..."></div></div></div>
            <div class="form-group"><label>üçΩÔ∏è Surco√ªt Pension</label><div class="input-with-button"><input type="number" id="surcharge_cost" name="surcharge_cost" value="0" class="cost-input"><select id="surcharge_type" name="surcharge_type"><option>Petit d√©jeuner</option><option>Demi pension</option><option selected>Pension compl√®te</option><option>All-In</option></select></div></div>
            
            <h3 class="section-divider"><span>Services Exclusifs</span></h3>
            <div class="form-group"><label for="exclusive_services">üéÅ Services Exclusifs Inclus</label><textarea id="exclusive_services" name="exclusive_services" placeholder="ex: Acc√®s au lounge VIP de l'a√©roport&#10;Une bouteille de champagne en chambre&#10;Check-out tardif jusqu'√† 14h"></textarea></div>
            <div class="form-group"><button type="button" id="toggleInstagramBtn" class="search-btn" style="width: auto; background-color: #f0f0f0; display: inline-flex; align-items: center; gap: 8px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.9 3.9 0 0 0-1.417.923A3.9 3.9 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.703.01 5.555 0 5.827 0 8s.01 2.444.048 3.297c.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.297-.048c.852-.04 1.433-.174 1.942-.372.526-.205.972-.478 1.417-.923.445-.444.718-.891.923-1.417.198-.51.333-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.444-.048-3.297c-.04-.852-.174-1.433-.372-1.942a3.9 3.9 0 0 0-.923-1.417A3.9 3.9 0 0 0 13.24.42c-.51-.198-1.09-.333-1.942-.372C10.445.01 10.173 0 8 0zm0 1.442c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599s.453.546.598.92c.11.282.24.705.275 1.486.039.843.047 1.096.047 3.232s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.486a2.5 2.5 0 0 1-.598.92 2.5 2.5 0 0 1-.92.598c-.282.11-.705.24-1.486.275-.843.038-1.096.047-3.232.047s-2.389-.008-3.232-.047c-.78-.035-1.203-.166-1.486-.275a2.5 2.5 0 0 1-.92-.598 2.5 2.5 0 0 1-.598-.92c-.11-.282-.24-.705-.275-1.486-.038-.843-.046-1.096-.046-3.232s.008-2.389.046-3.232c.035-.78.166-1.204.275-1.486.145-.373.319-.64.599-.92s.546-.453.92-.598c.282-.11.705-.24 1.486-.275.843-.039 1.096-.046 3.232-.046zM8 4.865a3.135 3.135 0 1 0 0 6.27 3.135 3.135 0 0 0 0-6.27zm0 5.143a2.008 2.008 0 1 1 0-4.016 2.008 2.008 0 0 1 0 4.016zm6.406-4.848a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5z"/></svg><span>Ajouter un profil Instagram (Optionnel)</span></button><div id="instagram_wrapper" style="display:none; margin-top: 15px;"><label for="instagram_handle">üë§ Nom d'utilisateur ou URL du profil Instagram</label><input type="text" id="instagram_handle" name="instagram_handle" placeholder="ex: hotel_marbella ou https://instagram.com/hotel_marbella"></div></div>

            <button type="submit" id="generateBtn" class="generate-btn">üöÄ G√©n√©rer</button>
        </form>
    </div>
    <div class="loading" id="loading"><div class="loading-spinner"></div><h3>üîÑ Appels API s√©curis√©s...</h3></div>
    <div class="result" id="result"></div>
</div>

<div id="htmlCodeModal" class="modal">
    <div class="modal-content">
        <span class="close-button">√ó</span>
        <h2>Code HTML de la Fiche Voyage</h2>
        <textarea id="htmlCodeDisplay" class="html-textarea" readonly></textarea>
        <button id="copyHtmlCodeBtn" class="html-code-btn" style="margin-top: 15px;">üìã Copier le code</button>
        <div id="copyStatus" style="text-align:center; font-size: 14px; color: green; margin-top: 5px;"></div>
    </div>
</div>
<div id="client-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close-button">√ó</span>
        <h2 class="text-xl font-bold mb-4">Informations du Client</h2>
        <form id="client-form">
            <div class="space-y-4">
                <div><label for="client_first_name" class="block text-sm font-medium text-slate-700">Pr√©nom</label><input type="text" id="client_first_name" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"></div>
                <div><label for="client_last_name" class="block text-sm font-medium text-slate-700">Nom</label><input type="text" id="client_last_name" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"></div>
                <div><label for="client_email" class="block text-sm font-medium text-slate-700">Email</label><input type="email" id="client_email" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"></div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" class="close-button bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">Annuler</button>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Enregistrer</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
<script async src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=places&callback=initializeApp"></script>
<script>
    let generatedData = null; 

    function initializeApp() {
        const formatDate = (d) => {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        new Litepicker({
            element: document.getElementById('date_range'),
            singleMode: false, lang: 'fr-FR', format: 'DD MMMM YYYY',
            setup: (picker) => {
                picker.on('selected', (date1, date2) => {
                    document.getElementById('date_start').value = formatDate(date1.dateInstance);
                    document.getElementById('date_end').value = formatDate(date2.dateInstance);
                });
            },
        });

        new Litepicker({
            element: document.getElementById('cancellation_date'),
            singleMode: true, lang: 'fr-FR', format: 'DD MMMM YYYY'
        });
        
        const cancellationCheckbox = document.getElementById('has_cancellation');
        const cancellationDateWrapper = document.getElementById('cancellation_date_wrapper');
        const flightPriceInput = document.getElementById('flight_price');
        const cancellationWarning = document.getElementById('cancellation-warning');

        function updateCancellationWarning() {
            const flightPrice = parseFloat(flightPriceInput.value) || 0;
            if (cancellationCheckbox.checked && flightPrice > 0) {
                cancellationWarning.textContent = `Attention : L'annulation gratuite ne s'applique qu'√† l'h√¥tel. Les vols (${flightPrice} ‚Ç¨) ne sont pas remboursables.`;
                cancellationWarning.style.display = 'block';
            } else {
                cancellationWarning.style.display = 'none';
            }
        }

        cancellationCheckbox.addEventListener('change', function() {
            cancellationDateWrapper.style.display = this.checked ? 'block' : 'none';
            updateCancellationWarning();
        });

        flightPriceInput.addEventListener('input', updateCancellationWarning);

        document.getElementById('toggleInstagramBtn').addEventListener('click', function() {
            document.getElementById('instagram_wrapper').style.display = document.getElementById('instagram_wrapper').style.display === 'block' ? 'none' : 'block';
        });

        const hotelInput = document.getElementById('hotel_name');
        const destinationInput = document.getElementById('destination');
        const starsSelect = document.getElementById('stars');
        const departureInput = document.getElementById('departure_city');
        const arrivalInput = document.getElementById('arrival_airport');
        
        const destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput, { types: ['(regions)'], fields: ['geometry', 'name'] });
        const hotelAutocomplete = new google.maps.places.Autocomplete(hotelInput, { types: ['lodging'] });
        new google.maps.places.Autocomplete(departureInput, { types: ['airport'] });
        new google.maps.places.Autocomplete(arrivalInput, { types: ['airport'] });
        hotelAutocomplete.setFields(['name', 'rating', 'address_components']);

        destinationAutocomplete.addListener('place_changed', () => {
            const place = destinationAutocomplete.getPlace();
            if (place.geometry && place.geometry.viewport) hotelAutocomplete.setBounds(place.geometry.viewport);
        });

        hotelAutocomplete.addListener('place_changed', () => {
            const hotelPlace = hotelAutocomplete.getPlace();
            if (hotelPlace.address_components) {
                let city = '', country = '';
                for (const component of hotelPlace.address_components) {
                    if (component.types.includes('locality')) city = component.long_name;
                    if (component.types.includes('country')) country = component.long_name;
                }
                if (city && country) destinationInput.value = `${city}, ${country}`;
            }
            if (hotelPlace && hotelPlace.rating) {
                const rating = parseFloat(hotelPlace.rating);
                if (rating >= 4.8) starsSelect.value = '5';
                else if (rating >= 3.8) starsSelect.value = '4';
                else starsSelect.value = '3';
            }
        });

        document.getElementById('searchBookingBtn').addEventListener('click', () => {
            const hotelName = hotelInput.value;
            const checkinDate = document.getElementById('date_start').value;
            const checkoutDate = document.getElementById('date_end').value;
            if (!hotelName || !checkinDate || !checkoutDate) return alert("Veuillez s√©lectionner un h√¥tel et des dates.");
            const bookingUrl = `https://www.booking.com/searchresults.html?ss=${encodeURIComponent(hotelName)}&checkin=${checkinDate}&checkout=${checkoutDate}&group_adults=2&no_rooms=1`;
            window.open(bookingUrl, '_blank');
        });

        document.getElementById('searchFlightsBtn').addEventListener('click', () => {
            const departureText = departureInput.value;
            const arrivalText = arrivalInput.value;
            const checkinDate = document.getElementById('date_start').value;
            const checkoutDate = document.getElementById('date_end').value;
            if (!departureText || !arrivalText || !checkinDate || !checkoutDate) return alert("Veuillez s√©lectionner les a√©roports de d√©part, d'arriv√©e et les dates.");
            const flightsUrl = `https://www.google.com/flights?hl=fr&q=vols+de+${encodeURIComponent(departureText)}+√†+${encodeURIComponent(arrivalText)}+le+${checkinDate}+retour+le+${checkoutDate}`;
            window.open(flightsUrl, '_blank');
        });

        const costInputs = document.querySelectorAll('.cost-input');
        costInputs.forEach(input => {
            input.addEventListener('input', updateCostTotals);
        });
        updateCostTotals();
    }

    function updateCostTotals() {
        const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;

        const hotelB2B = getVal('hotel_b2b_price');
        const hotelB2C = getVal('hotel_b2c_price');
        const flight = getVal('flight_price');
        const transfer = getVal('transfer_cost');
        const car = getVal('car_rental_cost');
        const surcharge = getVal('surcharge_cost');
        const packPrice = getVal('pack_price');

        const totalB2B = hotelB2B + flight + transfer + car + surcharge;
        const totalB2C = hotelB2C + flight + transfer + car + surcharge;
        const gap = totalB2C - totalB2B;
        const saving = totalB2C - packPrice;
        const margin = packPrice - totalB2B;

        document.getElementById('total-b2b-cost').textContent = `${totalB2B} ‚Ç¨`;
        document.getElementById('total-b2c-cost').textContent = `${totalB2C} ‚Ç¨`;
        document.getElementById('b2c-b2b-gap').textContent = `${gap} ‚Ç¨`;
        document.getElementById('client-saving').textContent = `${saving} ‚Ç¨`;
        document.getElementById('final-margin').textContent = `${margin} ‚Ç¨`;
    }

    document.getElementById('voyageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        if (!data.date_start || !data.date_end) return alert("Veuillez s√©lectionner une p√©riode de s√©jour.");

        document.getElementById('loading').style.display = 'block';
        document.getElementById('result').style.display = 'none';

        fetch('/api/generate-preview', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';

            if (data.success) {
                generatedData = data;
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Page g√©n√©r√©e !</div>
                    <div class="stats">
                        <div class="stat-item"><div class="stat-number">${data.api_data.photos.length}</div><div class="stat-label">Photos</div></div>
                        <div class="stat-item"><div class="stat-number">${data.api_data.videos.length}</div><div class="stat-label">Vid√©os</div></div>
                        <div class="stat-item"><div class="stat-number">${data.api_data.total_reviews}</div><div class="stat-label">Avis</div></div>
                        <div class="stat-item"><div class="stat-number">${Object.values(data.api_data.attractions).flat().length}</div><div class="stat-label">Attractions</div></div>
                        <div class="stat-item"><div class="stat-number" style="color: #10b981;">${data.margin}‚Ç¨</div><div class="stat-label">Marge</div></div>
                        <div class="stat-item"><div class="stat-number">${data.savings}‚Ç¨</div><div class="stat-label">√âconomies</div></div>
                    </div>
                    <div class="button-container">
                        <a href="#" id="previewBtn" class="view-btn">üëÅÔ∏è Pr√©visualiser</a>
                        <a href="#" id="downloadBtn" class="download-btn">üì• T√©l√©charger</a>
                        <button type="button" id="htmlCodeBtn" class="html-code-btn">üìÑ Code HTML</button>
                        <button type="button" id="editVideoBtn" class="edit-btn">‚úèÔ∏è Modifier Vid√©o</button>
                        <button type="button" id="resetFormBtn" class="reset-btn" title="Nouvelle recherche">üîÑ</button>
                    </div>
                    <div id="videoEditContainer" class="video-edit-form" style="display:none;"></div>
                    <div id="editConfirmation" style="font-weight: bold; text-align: center; margin-top: 15px;"></div>
                    <div style="margin-top: 30px; border-top: 2px solid #e1e5e9; padding-top: 20px; text-align: center;">
                        <h3 style="font-size: 1.2em; color: #333; margin-bottom: 15px;">Pr√™t √† sauvegarder ?</h3>
                        <div class="button-container">
                            <button id="saveProposedBtn" style="background: #28a745;" class="download-btn">Enregistrer comme Proposition</button>
                            <button id="saveCustomBtn" style="background: #fd7e14;" class="download-btn">Cr√©er pour un Client</button>
                        </div>
                    </div>`;
                
                attachResultListeners();

            } else {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${data.error}</div>`;
            }
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('result').style.display = 'block';
            document.getElementById('result').innerHTML = `<div class="error">‚ùå Erreur de connexion: ${error.message}</div>`;
        });
    });

    function attachResultListeners() {
        document.getElementById('resetFormBtn').addEventListener('click', () => {
            document.getElementById('voyageForm').reset();
            document.getElementById('cancellation_date_wrapper').style.display = 'none';
            document.getElementById('result').style.display = 'none';
            updateCostTotals();
            document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
        });

        document.getElementById('previewBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const html = await getPreviewHtml();
            if (html) {
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
            }
        });

        document.getElementById('downloadBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const html = await getPreviewHtml();
            if (html) {
                const blob = new Blob([html], { type: 'text/html' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `fiche_${generatedData.form_data.hotel_name.replace(/ /g, '_')}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        document.getElementById('htmlCodeBtn').addEventListener('click', async () => {
            const html = await getPreviewHtml();
            if (html) {
                document.getElementById('htmlCodeDisplay').value = html;
                document.getElementById('htmlCodeModal').style.display = 'flex';
            }
        });

        document.getElementById('editVideoBtn').addEventListener('click', (e) => {
            e.preventDefault();
            const videoEditContainer = document.getElementById('videoEditContainer');
            const currentVideo = generatedData.api_data.videos[0];
            videoEditContainer.innerHTML = `
                <input type="text" id="newVideoUrl" placeholder="Coller la nouvelle URL YouTube ici..." value="${currentVideo ? `https://www.youtube.com/watch?v=${currentVideo.id}` : ''}">
                <button id="submitVideoChange" style="background-color: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer;">Valider</button>
                <button id="deleteVideoBtn" style="background-color: #dc3545; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer;">Pas de Vid√©o</button>
            `;
            videoEditContainer.style.display = 'flex';
            e.target.style.display = 'none';

            document.getElementById('submitVideoChange').addEventListener('click', () => {
                const newUrl = document.getElementById('newVideoUrl').value;
                const videoIdMatch = newUrl.match(/(?:v=|\/)([a-zA-Z0-9_-]{11}).*/);
                if (videoIdMatch && videoIdMatch[1]) {
                    generatedData.api_data.videos = [{ id: videoIdMatch[1], title: 'Nouvelle Vid√©o' }];
                    document.getElementById('editConfirmation').textContent = '‚úÖ Vid√©o mise √† jour. Cliquez sur "Pr√©visualiser" pour voir les changements.';
                } else {
                    alert("URL YouTube invalide.");
                }
                videoEditContainer.style.display = 'none';
                document.getElementById('editVideoBtn').style.display = 'inline-block';
            });
            document.getElementById('deleteVideoBtn').addEventListener('click', () => {
                generatedData.api_data.videos = [];
                document.getElementById('editConfirmation').textContent = '‚úÖ Vid√©o supprim√©e. Cliquez sur "Pr√©visualiser" pour voir les changements.';
                videoEditContainer.style.display = 'none';
                document.getElementById('editVideoBtn').style.display = 'inline-block';
            });
        });

        document.getElementById('saveProposedBtn').addEventListener('click', () => {
            if (!generatedData) return;
            saveTripData({ ...generatedData, status: 'proposed' });
        });

        document.getElementById('saveCustomBtn').addEventListener('click', () => {
            if (!generatedData) return;
            document.getElementById('client-modal').style.display = 'flex';
        });
    }

    async function getPreviewHtml() {
        if (!generatedData) return null;
        try {
            const response = await fetch('/api/render-html-preview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(generatedData)
            });
            if (!response.ok) throw new Error('La g√©n√©ration du HTML a √©chou√©.');
            return await response.text();
        } catch (error) {
            alert(error.message);
            return null;
        }
    }

    // Gestion des modales
    document.querySelectorAll('.modal .close-button').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.closest('.modal').style.display = 'none';
        });
    });
    window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    });
    document.getElementById('copyHtmlCodeBtn').addEventListener('click', () => {
        const textarea = document.getElementById('htmlCodeDisplay');
        textarea.select();
        document.execCommand("copy");
        const copyStatus = document.getElementById('copyStatus');
        copyStatus.textContent = "‚úÖ Code copi√© !";
        setTimeout(() => { copyStatus.textContent = ""; }, 2000);
    });
    document.getElementById('client-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const clientData = {
            client_first_name: document.getElementById('client_first_name').value,
            client_last_name: document.getElementById('client_last_name').value,
            client_email: document.getElementById('client_email').value,
        };
        saveTripData({ ...generatedData, status: 'assigned', ...clientData });
        document.getElementById('client-modal').style.display = 'none';
    });

    async function saveTripData(payload) {
        try {
            const response = await fetch('/api/trips', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.success) {
                alert('Voyage enregistr√© avec succ√®s !');
                window.location.href = `/dashboard?view=${result.trip.status}`;
            } else {
                alert('Erreur lors de la sauvegarde: ' + result.error);
            }
        } catch (error) {
            alert('Une erreur r√©seau est survenue lors de la sauvegarde.');
            console.error(error);
        }
    }
</script>
{% endblock %}{% endraw %}