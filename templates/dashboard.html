cat > templates/dashboard.html << 'EOF'
{% extends "base.html" %}

{% block title %}Tableau de Bord{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script async src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=places"></script>
<style>
    .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
    .modal.is-open { display: flex; }
    .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 10px; max-height: 90vh; overflow-y: auto; }
    .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close-button:hover { color: black; }
    #edit-trip-modal .summary-view { display: block; }
    #edit-trip-modal .edit-view { display: none; }
    #edit-trip-modal.is-editing .summary-view { display: none; }
    #edit-trip-modal.is-editing .edit-view { display: block; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
    .summary-item { display: flex; align-items: center; background-color: #f9fafb; padding: 0.5rem; border-radius: 0.5rem; font-size: 0.875rem; }
    .summary-item i { font-size: 1.1rem; color: #4b5563; margin-right: 0.75rem; width: 20px; text-align: center; }
    .summary-item.col-span-full { grid-column: 1 / -1; }
    .pac-container { z-index: 10000 !important; }
    .cost-calculator { display: flex; gap: 20px; background-color: #f8fafc; padding: 15px; border-radius: 10px; margin-top: 1rem; flex-wrap: wrap; }
    .cost-calculator div { flex: 1; text-align: center; min-width: 100px; }
    .cost-calculator p { margin: 0; color: #4b5563; font-weight: 500; font-size: 14px; }
    .cost-calculator .cost-value { font-size: 22px; font-weight: bold; color: #1e293b; }
    .financial-summary { background-color: #f8fafc; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; margin-top: 1.5rem; }
    .financial-summary .title { font-weight: 600; color: #374151; margin-bottom: 0.75rem; font-size: 1.125rem; }
    .financial-summary .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    .financial-summary .item { text-align: center; }
    .financial-summary .label { font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; }
    .financial-summary .value { font-size: 1.25rem; font-weight: 700; color: #1f2937; }
    .financial-summary .value.positive { color: #10b981; }
    .financial-summary .value.negative { color: #ef4444; }
    .disabled-btn { opacity: 0.5; cursor: not-allowed; }
</style>
{% endblock %}

{% block content %}
<div>
    <h1 class="text-3xl font-bold text-slate-800 mb-6">
        {% if view_mode == 'proposed' %}Voyages Propos√©s
        {% elif view_mode == 'assigned' %}Voyage Client
        {% elif view_mode == 'sold' %}Voyages Vendus
        {% endif %}
    </h1>

    <div class="bg-white p-6 rounded-2xl shadow-lg">
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="border-b-2 border-slate-200">
                    <tr>
                        {% if view_mode == 'proposed' %}
                            <th class="p-3 text-sm font-semibold text-slate-500">Date Ajout</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Vendeur</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">H√¥tel</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Destination</th>
                            <th class="p-3 text-sm font-semibold text-slate-500 text-center">Publier</th>
                            <th class="p-3 text-sm font-semibold text-slate-500 text-right">Actions</th>
                        {% elif view_mode == 'assigned' %}
                            <th class="p-3 text-sm font-semibold text-slate-500">Date Assign.</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Vendeur</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">H√¥tel</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Client</th>
                            <th class="p-3 text-sm font-semibold text-slate-500 text-right">Actions</th>
                        {% elif view_mode == 'sold' %}
                            <th class="p-3 text-sm font-semibold text-slate-500">Date Vente</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Vendeur</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">H√¥tel</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Client</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Prix</th>
                            <th class="p-3 text-sm font-semibold text-slate-500 text-right">Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="trips-table-body">
                    <tr id="loading-row"><td colspan="6" class="text-center p-8 text-slate-500">Chargement...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="edit-trip-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="document.getElementById('edit-trip-modal').classList.remove('is-open')">&times;</span>
        <h2 class="text-2xl font-bold mb-4">D√©tails du Voyage</h2>
        
        <div class="summary-view">
            <div id="trip-summary" class="summary-grid"></div>
            <button onclick="document.getElementById('edit-trip-modal').classList.add('is-editing')" class="mt-4 bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg">Modifier l'offre</button>
        </div>
        
        <div class="edit-view">
            <form id="edit-trip-form" class="space-y-4">
                <input type="hidden" id="edit-trip-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium">Prix B2B H√¥tel (‚Ç¨)</label><input type="number" id="edit-hotel-b2b" class="w-full p-2 border rounded cost-input"></div>
                    <div><label class="block text-sm font-medium">Prix B2C H√¥tel (‚Ç¨)</label><input type="number" id="edit-hotel-b2c" class="w-full p-2 border rounded cost-input"></div>
                    <div><label class="block text-sm font-medium">Prix Vol (‚Ç¨)</label><input type="number" id="edit-flight" class="w-full p-2 border rounded cost-input"></div>
                    <div><label class="block text-sm font-medium">Transferts (‚Ç¨)</label><input type="number" id="edit-transfer" class="w-full p-2 border rounded cost-input"></div>
                    <div><label class="block text-sm font-medium">Location voiture (‚Ç¨)</label><input type="number" id="edit-car" class="w-full p-2 border rounded cost-input"></div>
                    <div><label class="block text-sm font-medium">Surco√ªt pension (‚Ç¨)</label><input type="number" id="edit-surcharge" class="w-full p-2 border rounded cost-input"></div>
                </div>
                <div><label class="block text-sm font-medium">Prix du Pack Final (‚Ç¨)</label><input type="number" id="edit-pack-price" class="w-full p-2 border rounded cost-input"></div>
                
                <div class="cost-calculator">
                    <div><p>Co√ªt Total B2B</p><span id="edit-total-b2b" class="cost-value">0 ‚Ç¨</span></div>
                    <div><p>√âconomie Client</p><span id="edit-client-saving" class="cost-value positive">0 ‚Ç¨</span></div>
                    <div><p>Marge Finale</p><span id="edit-final-margin" class="cost-value">0 ‚Ç¨</span></div>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="edit-is-ultra-budget" class="mr-2">
                    <label for="edit-is-ultra-budget" class="text-sm font-medium text-red-600">Marquer comme Ultra Budget</label>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="document.getElementById('edit-trip-modal').classList.remove('is-editing')" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">Annuler</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const viewMode = '{{ view_mode }}';
    const sitePublicUrl = '{{ site_public_url }}';
    const tableBody = document.getElementById('trips-table-body');
    const currentUserId = {{ session.get('user_id') }};
    const isAdmin = "{{ session.get('role') }}" === 'admin';

    async function fetchTrips() {
        try {
            const response = await fetch(`/api/trips?status=${viewMode}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const trips = await response.json();
            renderTable(trips);
        } catch (error) {
            console.error("Fetch error:", error);
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-red-500">Erreur de chargement des donn√©es.</td></tr>`;
        }
    }

    function renderTable(trips) {
        tableBody.innerHTML = '';
        if (trips.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-slate-500">Aucun voyage √† afficher.</td></tr>`;
            return;
        }
        trips.forEach(trip => {
            const row = document.createElement('tr');
            let rowClasses = ['border-b', 'border-slate-100', 'hover:bg-slate-50'];

            if (viewMode === 'assigned' && trip.balance_due_date) {
                const dueDate = new Date(trip.balance_due_date);
                const today = new Date();
                const sevenDaysFromNow = new Date();
                sevenDaysFromNow.setDate(today.getDate() + 7);
                today.setHours(0,0,0,0);

                if (dueDate < today) {
                    rowClasses.push('bg-red-200');
                } else if (dueDate <= sevenDaysFromNow) {
                    rowClasses.push('bg-orange-200');
                }
            }
            row.className = rowClasses.join(' ');
            row.dataset.tripId = trip.id;
            
            const canEdit = isAdmin || trip.user_id === currentUserId;
            const disabledClass = canEdit ? '' : 'disabled-btn';
            const disabledAttr = canEdit ? '' : 'disabled';
            
            let rowHtml = '';
            if (viewMode === 'proposed') {
                rowHtml = `
                    <td class="p-3 text-sm text-slate-600">${trip.created_at}</td>
                    <td class="p-3 text-sm text-slate-600">${trip.creator_pseudo}</td>
                    <td class="p-3 font-medium text-slate-800">${trip.hotel_name}</td>
                    <td class="p-3 text-sm text-slate-600">${trip.destination}</td>
                    <td class="p-3 text-center">
                        <label class="relative inline-flex items-center cursor-pointer ${disabledClass}">
                            <input type="checkbox" data-action="toggle-publish" class="sr-only peer" ${trip.is_published ? 'checked' : ''} ${disabledAttr}>
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </td>
                    <td class="p-3 text-right space-x-2">
                        <button data-action="repropose" title="Reproposer ce voyage" class="text-indigo-500 text-xl">üîÑ</button>
                        <button data-action="sell" title="Assigner √† un client" class="text-blue-500 text-xl ${disabledClass}" ${disabledAttr}>üí∞</button>
                        <button data-action="delete" title="Supprimer" class="text-red-500 text-xl ${disabledClass}" ${disabledAttr}>üóëÔ∏è</button>
                    </td>`;
            } else if (viewMode === 'assigned') {
                 rowHtml = `
                    <td class="p-3 text-sm text-slate-600">${trip.assigned_at}</td>
                    <td class="p-3 text-sm text-slate-600">${trip.creator_pseudo}</td>
                    <td class="p-3 font-medium text-slate-800">${trip.hotel_name}</td>
                    <td class="p-3 text-sm text-slate-600">${trip.client_full_name}</td>
                    <td class="p-3 text-right space-x-2">
                        <button data-action="edit-trip" title="Ajuster l'offre client" class="text-yellow-500 text-xl ${disabledClass}" ${disabledAttr}>‚öôÔ∏è</button>
                        <button data-action="mark-paid" title="Marquer comme Pay√©" class="text-green-500 text-xl ${disabledClass}" ${disabledAttr}>‚úÖ</button>
                        <button data-action="delete" title="Supprimer la fiche client" class="text-red-500 text-xl ${disabledClass}" ${disabledAttr}>üóëÔ∏è</button>
                    </td>`;
            } else if (viewMode === 'sold') {
                rowHtml = `
                    <td class="p-3 text-sm text-slate-600">${trip.sold_at || 'N/A'}</td>
                    <td class="p-3 text-sm text-slate-600">${trip.creator_pseudo}</td>
                    <td class="p-3 font-medium text-slate-800">${trip.hotel_name}</td>
                    <td class="p-3 text-sm text-slate-600">${trip.client_full_name}</td>
                    <td class="p-3 text-sm text-slate-600">${trip.price}‚Ç¨</td>
                    <td class="p-3 text-right space-x-2">
                         <button data-action="view" title="Voir les d√©tails" class="text-blue-500 text-xl">üëÅÔ∏è</button>
                         <button data-action="delete" title="Supprimer l'archive" class="text-red-500 text-xl ${disabledClass}" ${disabledAttr}>üóëÔ∏è</button>
                    </td>`;
            }
            row.innerHTML = rowHtml;
            tableBody.appendChild(row);
        });
    }

    tableBody.addEventListener('click', async function(e) {
        const actionTarget = e.target.closest('[data-action]');
        if (!actionTarget) return;

        const action = actionTarget.dataset.action;
        const tripRow = actionTarget.closest('tr');
        const tripId = tripRow.dataset.tripId;

        if (action === 'toggle-publish') {
            const checkbox = actionTarget;
            const shouldPublish = checkbox.checked;
            
            try {
                const response = await fetch(`/api/trip/${tripId}/publish`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({publish: shouldPublish})
                });
                const result = await response.json();
                if (result.success) {
                    if (shouldPublish && result.url) {
                        alert(`Voyage publi√© !\nURL: ${result.url}`);
                    }
                } else {
                    alert('Erreur: ' + result.message);
                    checkbox.checked = !shouldPublish;
                }
            } catch (error) {
                alert('Erreur r√©seau');
                checkbox.checked = !shouldPublish;
            }
        }

        if (action === 'repropose') {
            const clientsResponse = await fetch('/api/clients');
            const clients = await clientsResponse.json();
            const clientId = prompt(`Entrez l'ID du client:\n${clients.map(c => `${c.id}: ${c.full_name}`).join('\n')}`);
            
            if (clientId) {
                try {
                    const response = await fetch(`/api/trip/${tripId}/repropose`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({client_id: clientId})
                    });
                    const result = await response.json();
                    alert(result.message);
                    if (result.success) fetchTrips();
                } catch (error) {
                    alert('Erreur r√©seau');
                }
            }
        }

        if (action === 'sell') {
            const clientsResponse = await fetch('/api/clients');
            const clients = await clientsResponse.json();
            const clientId = prompt(`Entrez l'ID du client:\n${clients.map(c => `${c.id}: ${c.full_name}`).join('\n')}`);
            
            if (clientId) {
                try {
                    const response = await fetch(`/api/trip/${tripId}/repropose`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({client_id: clientId})
                    });
                    const result = await response.json();
                    alert(result.message);
                    if (result.success) fetchTrips();
                } catch (error) {
                    alert('Erreur r√©seau');
                }
            }
        }

        if (action === 'edit-trip') {
            try {
                const response = await fetch(`/api/trip/${tripId}`);
                const trip = await response.json();
                const fullData = JSON.parse(trip.full_data_json || '{}');
                const formData = fullData.form_data || {};
                
                document.getElementById('edit-trip-id').value = tripId;
                document.getElementById('edit-hotel-b2b').value = formData.hotel_b2b_price || 0;
                document.getElementById('edit-hotel-b2c').value = formData.hotel_b2c_price || 0;
                document.getElementById('edit-flight').value = formData.flight_price || 0;
                document.getElementById('edit-transfer').value = formData.transfer_cost || 0;
                document.getElementById('edit-car').value = formData.car_rental_cost || 0;
                document.getElementById('edit-surcharge').value = formData.surcharge_cost || 0;
                document.getElementById('edit-pack-price').value = formData.pack_price || 0;
                document.getElementById('edit-is-ultra-budget').checked = formData.is_ultra_budget || false;
                
                updateEditCosts();
                document.getElementById('edit-trip-modal').classList.add('is-open');
            } catch (error) {
                alert('Erreur de chargement');
            }
        }

        if (action === 'mark-paid') {
            if (confirm('Marquer ce voyage comme vendu ?')) {
                try {
                    const response = await fetch(`/api/trip/${tripId}/mark_sold`, {method: 'POST'});
                    const result = await response.json();
                    alert(result.message);
                    if (result.success) fetchTrips();
                } catch (error) {
                    alert('Erreur r√©seau');
                }
            }
        }

        if (action === 'delete') {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce voyage ?')) {
                try {
                    const response = await fetch(`/api/trip/${tripId}`, {method: 'DELETE'});
                    const result = await response.json();
                    alert(result.message);
                    if (result.success) fetchTrips();
                } catch (error) {
                    alert('Erreur r√©seau');
                }
            }
        }

        if (action === 'view') {
            try {
                const response = await fetch(`/api/trip/${tripId}`);
                const trip = await response.json();
                alert(`D√©tails du voyage:\n\nH√¥tel: ${trip.hotel_name}\nClient: ${trip.client_full_name}\nPrix: ${trip.price}‚Ç¨\nDate de vente: ${trip.sold_at}`);
            } catch (error) {
                alert('Erreur de chargement');
            }
        }
    });

    function updateEditCosts() {
        const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
        const hotelB2B = getVal('edit-hotel-b2b');
        const hotelB2C = getVal('edit-hotel-b2c');
        const flight = getVal('edit-flight');
        const transfer = getVal('edit-transfer');
        const car = getVal('edit-car');
        const surcharge = getVal('edit-surcharge');
        const packPrice = getVal('edit-pack-price');

        const totalB2B = hotelB2B + flight + transfer + car + surcharge;
        const totalB2C = hotelB2C + flight + transfer + car + surcharge;
        const saving = totalB2C - packPrice;
        const margin = packPrice - totalB2B;

        document.getElementById('edit-total-b2b').textContent = `${totalB2B} ‚Ç¨`;
        document.getElementById('edit-client-saving').textContent = `${saving} ‚Ç¨`;
        document.getElementById('edit-final-margin').textContent = `${margin} ‚Ç¨`;
    }

    document.querySelectorAll('#edit-trip-form .cost-input').forEach(input => {
        input.addEventListener('input', updateEditCosts);
    });

    document.getElementById('edit-trip-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const tripId = document.getElementById('edit-trip-id').value;
        
        const formData = {
            hotel_b2b_price: document.getElementById('edit-hotel-b2b').value,
            hotel_b2c_price: document.getElementById('edit-hotel-b2c').value,
            flight_price: document.getElementById('edit-flight').value,
            transfer_cost: document.getElementById('edit-transfer').value,
            car_rental_cost: document.getElementById('edit-car').value,
            surcharge_cost: document.getElementById('edit-surcharge').value,
            pack_price: document.getElementById('edit-pack-price').value,
            is_ultra_budget: document.getElementById('edit-is-ultra-budget').checked
        };

        try {
            const response = await fetch(`/api/trip/${tripId}/update`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            });
            const result = await response.json();
            alert(result.message);
            if (result.success) {
                document.getElementById('edit-trip-modal').classList.remove('is-open', 'is-editing');
                fetchTrips();
            }
        } catch (error) {
            alert('Erreur r√©seau');
        }
    });

    fetchTrips();
});
</script>
{% endblock %}
EOF