{% extends "base.html" %}

{% block title %}Tableau de Bord{% endblock %}

{% block head_extra %}
<style>
    .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
    .modal.is-open { display: flex; }
    .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 10px; }
    .disabled-btn { opacity: 0.5; cursor: not-allowed; }
</style>
{% endblock %}

{% block content %}
<div>
    <h1 class="text-3xl font-bold text-slate-800 mb-6">
        {% if view_mode == 'proposed' %}Voyages Propos√©s
        {% elif view_mode == 'assigned' %}Voyages Clients
        {% elif view_mode == 'sold' %}Voyages Vendus
        {% endif %}
    </h1>

    <div class="bg-white p-6 rounded-2xl shadow-lg">
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="border-b-2 border-slate-200">
                    <tr>
                        {% if view_mode == 'proposed' %}
                            <th class="p-3 text-sm font-semibold text-slate-500">Date Ajout</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Vendeur</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">H√¥tel</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Destination</th>
                            <th class="p-3 text-sm font-semibold text-slate-500 text-center">Publier</th>
                            <th class="p-3 text-sm font-semibold text-slate-500 text-right">Actions</th>
                        {% elif view_mode == 'assigned' %}
                            <th class="p-3 text-sm font-semibold text-slate-500">Date Assign.</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Vendeur</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">H√¥tel</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Client</th>
                            <th class="p-3 text-sm font-semibold text-slate-500 text-right">Actions</th>
                        {% elif view_mode == 'sold' %}
                            <th class="p-3 text-sm font-semibold text-slate-500">Date Vente</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Vendeur</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">H√¥tel</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Client</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Prix</th>
                            <th class="p-3 text-sm font-semibold text-slate-500 text-right">Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="trips-table-body">
                    <tr id="loading-row"><td colspan="6" class="text-center p-8 text-slate-500">Chargement...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="assign-client-modal" class="modal">
    <div class="modal-content">
        <h2 class="text-xl font-bold mb-4">Assigner le voyage</h2>
        <input type="hidden" id="assign-trip-id">
        
        <div class="border-b border-gray-200 mb-4">
            <nav class="flex space-x-4">
                <button id="tab-new-client" class="px-3 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600">Nouveau Client</button>
                <button id="tab-existing-client" class="px-3 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500">Client Existant</button>
            </nav>
        </div>

        <form id="new-client-form-dashboard">
            <div class="space-y-4">
                <div><label class="block text-sm font-medium text-slate-700">Pr√©nom</label><input type="text" id="client_first_name_dashboard" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2 border"></div>
                <div><label class="block text-sm font-medium text-slate-700">Nom</label><input type="text" id="client_last_name_dashboard" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2 border"></div>
                <div><label class="block text-sm font-medium text-slate-700">Email</label><input type="email" id="client_email_dashboard" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2 border"></div>
                <div><label class="block text-sm font-medium text-slate-700">T√©l√©phone</label><input type="tel" id="client_phone_dashboard" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2 border"></div>
            </div>
        </form>

        <form id="existing-client-form-dashboard" style="display: none;">
            <div>
                <label class="block text-sm font-medium text-slate-700">S√©lectionner un client existant</label>
                <select id="assign-client-id" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2 border">
                    <option value="">-- Choisir un client --</option>
                </select>
            </div>
        </form>

        <div class="mt-6 flex justify-end space-x-3">
            <button type="button" class="close-modal-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">Annuler</button>
            <button type="button" id="submit-assign-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Assigner</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    'use strict';
    
    console.log('üöÄ Dashboard script loaded');
    
    const viewMode = '{{ view_mode }}';
    const sitePublicUrl = '{{ site_public_url }}';
    const currentUserId = {{ session.get('user_id') }};
    const isAdmin = {{ 'true' if session.get('role') == 'admin' else 'false' }};
    
    const tableBody = document.getElementById('trips-table-body');
    const assignModal = document.getElementById('assign-client-modal');
    
    console.log('üìä View mode:', viewMode);
    console.log('üë§ Current user:', currentUserId, 'isAdmin:', isAdmin);

    // Fonction principale de chargement
    function loadTrips() {
        console.log('üîÑ Loading trips...');
        
        fetch('/api/trips?status=' + viewMode)
            .then(function(response) {
                console.log('üì° Response status:', response.status);
                if (!response.ok) {
                    throw new Error('HTTP error ' + response.status);
                }
                return response.json();
            })
            .then(function(trips) {
                console.log('‚úÖ Trips loaded:', trips.length, 'items');
                console.log('üì¶ Data:', trips);
                displayTrips(trips);
            })
            .catch(function(error) {
                console.error('‚ùå Error loading trips:', error);
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-red-500">Erreur: ' + error.message + '</td></tr>';
            });
    }

    // Affichage des voyages
    function displayTrips(trips) {
        console.log('üé® Displaying', trips.length, 'trips');
        
        tableBody.innerHTML = '';
        
        if (trips.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-slate-500">Aucun voyage √† afficher.</td></tr>';
            return;
        }

        trips.forEach(function(trip) {
            console.log('‚ûï Adding trip:', trip.id, trip.hotel_name);
            
            const row = document.createElement('tr');
            row.className = 'border-b border-slate-100 hover:bg-slate-50';
            row.dataset.tripId = trip.id;
            
            const canEdit = isAdmin || trip.user_id === currentUserId;
            const disabled = canEdit ? '' : 'disabled';
            const disabledClass = canEdit ? '' : 'opacity-50 cursor-not-allowed';
            
            let html = '';
            
            if (viewMode === 'proposed') {
                const viewLink = trip.is_published 
                    ? '<a href="' + sitePublicUrl + '/offres/' + trip.published_filename + '" target="_blank" title="Voir en ligne" class="text-blue-500 text-xl">üëÅÔ∏è</a>'
                    : '<span title="Non publi√©" class="text-gray-400 text-xl">üëÅÔ∏è</span>';
                
                html = '<td class="p-3 text-sm text-slate-600">' + trip.created_at + '</td>' +
                       '<td class="p-3 text-sm text-slate-600">' + trip.creator_pseudo + '</td>' +
                       '<td class="p-3 font-medium text-slate-800">' + trip.hotel_name + '</td>' +
                       '<td class="p-3 text-sm text-slate-600">' + trip.destination + '</td>' +
                       '<td class="p-3 text-center"><label class="relative inline-flex items-center cursor-pointer ' + disabledClass + '">' +
                       '<input type="checkbox" data-action="toggle-publish" class="sr-only peer" ' + (trip.is_published ? 'checked' : '') + ' ' + disabled + '>' +
                       '<div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[\'\'] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>' +
                       '</label></td>' +
                       '<td class="p-3 text-right space-x-2">' + viewLink +
                       '<button data-action="assign" title="Assigner" class="text-blue-500 text-xl ' + disabledClass + '" ' + disabled + '>üí∞</button>' +
                       '<button data-action="delete" title="Supprimer" class="text-red-500 text-xl ' + disabledClass + '" ' + disabled + '>üóëÔ∏è</button>' +
                       '</td>';
                       
            } else if (viewMode === 'assigned') {
                const clientName = trip.client_full_name || '‚ö†Ô∏è Sans client';
                html = '<td class="p-3 text-sm text-slate-600">' + (trip.assigned_at || 'N/A') + '</td>' +
                       '<td class="p-3 text-sm text-slate-600">' + trip.creator_pseudo + '</td>' +
                       '<td class="p-3 font-medium text-slate-800">' + trip.hotel_name + '</td>' +
                       '<td class="p-3 text-sm text-slate-600">' + clientName + '</td>' +
                       '<td class="p-3 text-right space-x-2">' +
                       '<button data-action="mark-sold" title="Marquer vendu" class="text-green-500 text-xl ' + disabledClass + '" ' + disabled + '>‚úÖ</button>' +
                       '<button data-action="delete" title="Supprimer" class="text-red-500 text-xl ' + disabledClass + '" ' + disabled + '>üóëÔ∏è</button>' +
                       '</td>';
                       
            } else if (viewMode === 'sold') {
                const clientName = trip.client_full_name || '‚ö†Ô∏è Sans client';
                html = '<td class="p-3 text-sm text-slate-600">' + (trip.sold_at || 'N/A') + '</td>' +
                       '<td class="p-3 text-sm text-slate-600">' + trip.creator_pseudo + '</td>' +
                       '<td class="p-3 font-medium text-slate-800">' + trip.hotel_name + '</td>' +
                       '<td class="p-3 text-sm text-slate-600">' + clientName + '</td>' +
                       '<td class="p-3 text-sm text-slate-600 font-semibold">' + trip.price + '‚Ç¨</td>' +
                       '<td class="p-3 text-right space-x-2">' +
                       '<button data-action="delete" title="Supprimer" class="text-red-500 text-xl ' + disabledClass + '" ' + disabled + '>üóëÔ∏è</button>' +
                       '</td>';
            }
            
            row.innerHTML = html;
            tableBody.appendChild(row);
        });
    }

    // Gestion des clics
    tableBody.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-action]');
        if (!btn || btn.disabled) return;
        
        const action = btn.dataset.action;
        const row = btn.closest('tr');
        const tripId = row.dataset.tripId;
        
        console.log('üñ±Ô∏è Action:', action, 'on trip', tripId);
        
        if (action === 'delete') {
            if (!confirm('Supprimer ce voyage ?')) return;
            fetch('/api/trip/' + tripId, { method: 'DELETE' })
                .then(function(r) { return r.json(); })
                .then(function(result) {
                    if (result.success) {
                        row.remove();
                    } else {
                        alert('Erreur: ' + result.message);
                    }
                });
                
        } else if (action === 'assign') {
            document.getElementById('assign-trip-id').value = tripId;
            loadClients();
            assignModal.classList.add('is-open');
            
        } else if (action === 'mark-sold') {
            if (!confirm('Marquer comme vendu ?')) return;
            fetch('/api/trip/' + tripId + '/mark_sold', { method: 'POST' })
                .then(function(r) { return r.json(); })
                .then(function(result) {
                    alert(result.message);
                    if (result.success) row.remove();
                });
        }
    });

    // Toggle publish
    tableBody.addEventListener('change', function(e) {
        if (!e.target.matches('[data-action="toggle-publish"]')) return;
        
        const checkbox = e.target;
        const tripId = checkbox.closest('tr').dataset.tripId;
        const shouldPublish = checkbox.checked;
        
        console.log('üîÑ Toggle publish:', tripId, shouldPublish);
        
        checkbox.disabled = true;
        
        fetch('/api/trip/' + tripId + '/publish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ publish: shouldPublish })
        })
        .then(function(r) { return r.json(); })
        .then(function(result) {
            if (result.success) {
                if (shouldPublish && result.url) {
                    alert('Publi√© !\nURL: ' + result.url);
                }
                loadTrips();
            } else {
                alert('Erreur: ' + result.message);
                checkbox.checked = !shouldPublish;
            }
        })
        .finally(function() {
            checkbox.disabled = false;
        });
    });

    // Gestion des onglets
    document.getElementById('tab-new-client').addEventListener('click', function() {
        document.getElementById('new-client-form-dashboard').style.display = 'block';
        document.getElementById('existing-client-form-dashboard').style.display = 'none';
        this.className = 'px-3 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
        document.getElementById('tab-existing-client').className = 'px-3 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500';
    });

    document.getElementById('tab-existing-client').addEventListener('click', function() {
        document.getElementById('new-client-form-dashboard').style.display = 'none';
        document.getElementById('existing-client-form-dashboard').style.display = 'block';
        this.className = 'px-3 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
        document.getElementById('tab-new-client').className = 'px-3 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500';
    });

    // Charger les clients
    function loadClients() {
        fetch('/api/clients')
            .then(function(r) { return r.json(); })
            .then(function(clients) {
                const select = document.getElementById('assign-client-id');
                select.innerHTML = '<option value="">-- Choisir --</option>';
                clients.forEach(function(client) {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.full_name;
                    select.appendChild(option);
                });
            });
    }

    // Assigner
    document.getElementById('submit-assign-btn').addEventListener('click', function() {
        const tripId = document.getElementById('assign-trip-id').value;
        const isNewClient = document.getElementById('new-client-form-dashboard').style.display !== 'none';
        
        let payload = {};
        
        if (isNewClient) {
            payload = {
                first_name: document.getElementById('client_first_name_dashboard').value,
                last_name: document.getElementById('client_last_name_dashboard').value,
                email: document.getElementById('client_email_dashboard').value,
                phone: document.getElementById('client_phone_dashboard').value
            };
            if (!payload.first_name || !payload.last_name || !payload.email) {
                alert('Remplissez tous les champs obligatoires');
                return;
            }
        } else {
            const clientId = document.getElementById('assign-client-id').value;
            if (!clientId) {
                alert('S√©lectionnez un client');
                return;
            }
            payload = { client_id: clientId };
        }
        
        this.disabled = true;
        this.textContent = 'En cours...';
        
        const btn = this;
        
        fetch('/api/trip/' + tripId + '/assign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(function(r) { return r.json(); })
        .then(function(result) {
            alert(result.message);
            if (result.success) {
                assignModal.classList.remove('is-open');
                loadTrips();
            }
        })
        .finally(function() {
            btn.disabled = false;
            btn.textContent = 'Assigner';
        });
    });

    // Fermer modal
    document.querySelectorAll('.close-modal-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            assignModal.classList.remove('is-open');
        });
    });

    // Chargement initial
    loadTrips();
})();
</script>
{% endblock %}