{% extends "base.html" %}

{% block title %}Tableau de Bord{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
    .modal.is-open { display: flex; }
    .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 10px; }
    .disabled-btn { opacity: 0.5; cursor: not-allowed; }
</style>
{% endblock %}

{% block content %}
<div>
    <h1 class="text-3xl font-bold text-slate-800 mb-6">
        {% if view_mode == 'proposed' %}Voyages Propos√©s
        {% elif view_mode == 'assigned' %}Voyages Clients
        {% elif view_mode == 'sold' %}Voyages Vendus
        {% endif %}
    </h1>

    <div class="bg-white p-6 rounded-2xl shadow-lg">
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="border-b-2 border-slate-200">
                    <tr>
                        {% if view_mode == 'proposed' %}
                            <th class="p-3 text-sm font-semibold text-slate-500">Date Ajout</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Vendeur</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">H√¥tel</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Destination</th>
                            <th class="p-3 text-sm font-semibold text-slate-500 text-center">Publier</th>
                            <th class="p-3 text-sm font-semibold text-slate-500 text-right">Actions</th>
                        {% elif view_mode == 'assigned' %}
                            <th class="p-3 text-sm font-semibold text-slate-500">Date Assign.</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Vendeur</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">H√¥tel</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Client</th>
                            <th class="p-3 text-sm font-semibold text-slate-500 text-right">Actions</th>
                        {% elif view_mode == 'sold' %}
                            <th class="p-3 text-sm font-semibold text-slate-500">Date Vente</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Vendeur</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">H√¥tel</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Client</th>
                            <th class="p-3 text-sm font-semibold text-slate-500">Prix</th>
                            <th class="p-3 text-sm font-semibold text-slate-500 text-right">Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="trips-table-body">
                    <tr id="loading-row"><td colspan="6" class="text-center p-8 text-slate-500">Chargement...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="assign-client-modal" class="modal">
    <div class="modal-content">
        <h2 id="assign-modal-title" class="text-xl font-bold mb-4">Assigner le voyage</h2>
        <input type="hidden" id="assign-trip-id">
        
        <div class="border-b border-gray-200 mb-4">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-new-client" class="px-3 py-2 font-medium text-sm rounded-t-lg border-b-2 border-blue-500 text-blue-600">Nouveau Client</button>
                <button id="tab-existing-client" class="px-3 py-2 font-medium text-sm rounded-t-lg border-b-2 border-transparent text-gray-500 hover:text-gray-700">Client Existant</button>
            </nav>
        </div>

        <form id="new-client-form-dashboard">
            <div class="space-y-4">
                <div><label for="client_first_name_dashboard" class="block text-sm font-medium text-slate-700">Pr√©nom</label><input type="text" id="client_first_name_dashboard" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2 border"></div>
                <div><label for="client_last_name_dashboard" class="block text-sm font-medium text-slate-700">Nom</label><input type="text" id="client_last_name_dashboard" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2 border"></div>
                <div><label for="client_email_dashboard" class="block text-sm font-medium text-slate-700">Email</label><input type="email" id="client_email_dashboard" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2 border"></div>
                <div><label for="client_phone_dashboard" class="block text-sm font-medium text-slate-700">T√©l√©phone</label><input type="tel" id="client_phone_dashboard" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2 border"></div>
            </div>
        </form>

        <form id="existing-client-form-dashboard" style="display: none;">
             <div>
                <label for="assign-client-id" class="block text-sm font-medium text-slate-700">S√©lectionner un client existant</label>
                <select id="assign-client-id" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2 border">
                    <option value="">-- Choisir un client --</option>
                </select>
            </div>
             <p class="text-center text-sm text-slate-500 mt-4">Ou <a href="{{ url_for('clients_page') }}" target="_blank" class="text-blue-600 underline">g√©rez vos clients ici</a>.</p>
        </form>

        <div class="mt-6 flex justify-end space-x-3">
            <button type="button" class="close-modal-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">Annuler</button>
            <button type="button" id="submit-assign-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Assigner et Publier</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const viewMode = '{{ view_mode }}';
    const sitePublicUrl = '{{ site_public_url }}';
    const tableBody = document.getElementById('trips-table-body');
    const assignClientModal = document.getElementById('assign-client-modal');

    const currentUserId = {{ session.get('user_id') | tojson }};
    const isAdmin = {{ session.get('role') == 'admin' | tojson }};

    async function fetchTrips() {
        try {
            const response = await fetch(`/api/trips?status=${viewMode}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const trips = await response.json();
            renderTable(trips);
        } catch (error) {
            console.error("Fetch error:", error);
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-red-500">Erreur de chargement des donn√©es.</td></tr>`;
        }
    }

    function renderTable(trips) {
        tableBody.innerHTML = '';
        if (trips.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-slate-500">Aucun voyage √† afficher.</td></tr>`;
            return;
        }
        trips.forEach(trip => {
            const row = document.createElement('tr');
            row.className = 'border-b border-slate-100 hover:bg-slate-50';
            row.dataset.tripId = trip.id;
            
            const canEdit = isAdmin || trip.user_id === currentUserId;
            const disabledClass = canEdit ? '' : 'disabled-btn';
            const disabledAttr = canEdit ? '' : 'disabled';
            
            let rowHtml = '';
            if (viewMode === 'proposed') {
                const viewOnlineLink = trip.is_published 
                    ? `<a href="${sitePublicUrl}/offres/${trip.published_filename}" target="_blank" title="Voir la fiche en ligne" class="text-blue-500 text-xl">üëÅÔ∏è</a>`
                    : `<span title="Publiez pour voir le lien" class="text-gray-400 text-xl cursor-not-allowed">üëÅÔ∏è</span>`;
                
                rowHtml = `
                    <td class="p-3 text-sm text-slate-600">${trip.created_at}</td>
                    <td class="p-3 text-sm text-slate-600">${trip.creator_pseudo}</td>
                    <td class="p-3 font-medium text-slate-800">${trip.hotel_name}</td>
                    <td class="p-3 text-sm text-slate-600">${trip.destination}</td>
                    <td class="p-3 text-center">
                        <label class="relative inline-flex items-center cursor-pointer ${disabledClass}">
                            <input type="checkbox" data-action="toggle-publish" class="sr-only peer" ${trip.is_published ? 'checked' : ''} ${disabledAttr}>
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </td>
                    <td class="p-3 text-right space-x-2">
                        ${viewOnlineLink}
                        <button data-action="assign" title="Assigner √† un client" class="text-blue-500 text-xl ${disabledClass}" ${disabledAttr}>üí∞</button>
                        <button data-action="delete" title="Supprimer" class="text-red-500 text-xl ${disabledClass}" ${disabledAttr}>üóëÔ∏è</button>
                    </td>`;
            } else if (viewMode === 'assigned') {
                 rowHtml = `
                    <td class="p-3 text-sm text-slate-600">${trip.assigned_at}</td>
                    <td class="p-3 text-sm text-slate-600">${trip.creator_pseudo}</td>
                    <td class="p-3 font-medium text-slate-800">${trip.hotel_name}</td>
                    <td class="p-3 text-sm text-slate-600">${trip.client_full_name}</td>
                    <td class="p-3 text-right space-x-2">
                        <button data-action="mark-sold" title="Marquer comme Vendu" class="text-green-500 text-xl ${disabledClass}" ${disabledAttr}>‚úÖ</button>
                        <button data-action="delete" title="Supprimer" class="text-red-500 text-xl ${disabledClass}" ${disabledAttr}>üóëÔ∏è</button>
                    </td>`;
            } else if (viewMode === 'sold') {
                rowHtml = `
                    <td class="p-3 text-sm text-slate-600">${trip.sold_at || 'N/A'}</td>
                    <td class="p-3 text-sm text-slate-600">${trip.creator_pseudo}</td>
                    <td class="p-3 font-medium text-slate-800">${trip.hotel_name}</td>
                    <td class="p-3 text-sm text-slate-600">${trip.client_full_name}</td>
                    <td class="p-3 text-sm text-slate-600 font-semibold">${trip.price}‚Ç¨</td>
                    <td class="p-3 text-right space-x-2">
                         <button data-action="delete" title="Supprimer l'archive" class="text-red-500 text-xl ${disabledClass}" ${disabledAttr}>üóëÔ∏è</button>
                    </td>`;
            }
            row.innerHTML = rowHtml;
            tableBody.appendChild(row);
        });
    }

    tableBody.addEventListener('click', async function(e) {
        const actionTarget = e.target.closest('[data-action]');
        if (!actionTarget || actionTarget.disabled) return;

        const action = actionTarget.dataset.action;
        const tripRow = actionTarget.closest('tr');
        const tripId = tripRow.dataset.tripId;

        if (action === 'toggle-publish') {
            const checkbox = actionTarget.querySelector('input');
            togglePublish(tripId, checkbox, tripRow);
        }
        else if (action === 'delete') {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce voyage ? Cette action est irr√©versible.')) {
                deleteTrip(tripId, tripRow);
            }
        }
        else if (action === 'assign') {
            document.getElementById('assign-trip-id').value = tripId;
            assignClientModal.querySelector('h2').textContent = 'Assigner le voyage √† un client';
            switchTab('new');
            loadClientsIntoModal();
            assignClientModal.classList.add('is-open');
        }
        else if (action === 'mark-sold') {
            if(confirm('Confirmez-vous que ce voyage est vendu ?')) {
                 updateTripStatus(tripId, 'sold', tripRow);
            }
        }
    });
    
    tableBody.addEventListener('change', function(e) {
        if (e.target.matches('input[type="checkbox"][data-action="toggle-publish"]') && !e.target.disabled) {
            const tripId = e.target.closest('tr').dataset.tripId;
            togglePublish(tripId, e.target, e.target.closest('tr'));
        }
    });

    async function togglePublish(tripId, checkbox, row) {
        const shouldPublish = checkbox.checked;
        checkbox.disabled = true;
        try {
            const response = await fetch(`/api/trip/${tripId}/publish`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({publish: shouldPublish})
            });
            const result = await response.json();
            if (result.success) {
                if (shouldPublish && result.url) {
                    alert(`Voyage publi√© !\nURL: ${result.url}`);
                }
                fetchTrips(); 
            } else {
                alert('Erreur: ' + result.message);
                checkbox.checked = !shouldPublish;
            }
        } catch (error) {
            alert('Erreur r√©seau.');
            checkbox.checked = !shouldPublish;
        } finally {
            checkbox.disabled = false;
        }
    }

    async function deleteTrip(tripId, row) {
        try {
            const response = await fetch(`/api/trip/${tripId}`, {method: 'DELETE'});
            const result = await response.json();
            if (result.success) {
                row.remove();
            } else {
                alert('Erreur: ' + result.message);
            }
        } catch (error) {
            alert('Erreur r√©seau.');
        }
    }
    
    const tabNewClient = document.getElementById('tab-new-client');
    const tabExistingClient = document.getElementById('tab-existing-client');
    const formNewClient = document.getElementById('new-client-form-dashboard');
    const formExistingClient = document.getElementById('existing-client-form-dashboard');

    function switchTab(tab) {
        if (tab === 'new') {
            tabNewClient.classList.add('border-blue-500', 'text-blue-600');
            tabNewClient.classList.remove('border-transparent', 'text-gray-500');
            tabExistingClient.classList.remove('border-blue-500', 'text-blue-600');
            tabExistingClient.classList.add('border-transparent', 'text-gray-500');
            formNewClient.style.display = 'block';
            formExistingClient.style.display = 'none';
        } else {
            tabExistingClient.classList.add('border-blue-500', 'text-blue-600');
            tabExistingClient.classList.remove('border-transparent', 'text-gray-500');
            tabNewClient.classList.remove('border-blue-500', 'text-blue-600');
            tabNewClient.classList.add('border-transparent', 'text-gray-500');
            formExistingClient.style.display = 'block';
            formNewClient.style.display = 'none';
        }
    }

    tabNewClient.addEventListener('click', () => switchTab('new'));
    tabExistingClient.addEventListener('click', () => switchTab('existing'));

    document.getElementById('submit-assign-btn').addEventListener('click', async function(e) {
        const tripId = document.getElementById('assign-trip-id').value;
        const button = e.target;
        button.disabled = true;
        button.textContent = 'En cours...';
        
        let payload;
        let isNewClient = formNewClient.style.display === 'block';
        let url = `/api/trip/${tripId}/assign`;

        if (isNewClient) {
            payload = {
                first_name: document.getElementById('client_first_name_dashboard').value,
                last_name: document.getElementById('client_last_name_dashboard').value,
                email: document.getElementById('client_email_dashboard').value,
                phone: document.getElementById('client_phone_dashboard').value,
            };
            if (!payload.first_name || !payload.last_name || !payload.email) {
                alert('Veuillez remplir les informations du nouveau client.');
                button.disabled = false;
                button.textContent = 'Assigner et Publier';
                return;
            }
        } else {
            const clientId = document.getElementById('assign-client-id').value;
            if (!clientId) {
                alert('Veuillez s√©lectionner un client existant.');
                button.disabled = false;
                button.textContent = 'Assigner et Publier';
                return;
            }
            payload = { client_id: clientId };
        }
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            alert(result.message);
            if (result.success) {
                assignClientModal.classList.remove('is-open');
                fetchTrips();
            }
        } catch (error) {
            alert('Erreur r√©seau lors de l\'assignation.');
        } finally {
            button.disabled = false;
            button.textContent = 'Assigner et Publier';
        }
    });

    async function loadClientsIntoModal() {
        const select = document.getElementById('assign-client-id');
        select.innerHTML = '<option value="">-- Chargement... --</option>';
        try {
            const response = await fetch('/api/clients');
            const clients = await response.json();
            select.innerHTML = '<option value="">-- Choisir un client --</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.full_name;
                select.appendChild(option);
            });
        } catch (error) {
            select.innerHTML = '<option value="">Erreur de chargement</option>';
        }
    }

    document.querySelectorAll('.close-modal-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.closest('.modal').classList.remove('is-open');
        });
    });

    fetchTrips();
});
</script>
{% endblock %}